# ===========================================================
#  PT_JP 日本节点 — Docker Compose 编排
#  客户端: qBittorrent 4.6.7 Official (MT白名单合规)
#  ⚠️ 非 Enhanced Edition！
#
#  使用方法:
#    cd PT_JP
#    cp .env.example .env && vim .env
#    docker compose up -d
# ===========================================================

services:
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:${QB_IMAGE_TAG:-4.6.7}
    # ↑ 锁定版本号！绝不使用 latest
    # linuxserver 镜像打包的是 qBittorrent Official
    # 验证: docker exec qbittorrent_jp qbittorrent-nox --version
    container_name: qbittorrent_jp
    restart: unless-stopped

    # ===== 资源硬限制 (防OOM导致SSH断连!) =====
    mem_limit: ${MEM_LIMIT:-4g}
    memswap_limit: ${MEM_SWAP:-5g}
    cpus: ${CPU_LIMIT:-3.5}
    # 解释: 8GB物理内存中，给容器4GB硬上限
    # 即使 qB 内存泄漏，也不会吃掉系统内存导致 SSH 断连

    # ===== 文件描述符 (5000种子必须!) =====
    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Asia/Shanghai}
      - WEBUI_PORT=${QB_WEBUI_PORT:-8080}

    ports:
      - "${QB_WEBUI_PORT:-8080}:${QB_WEBUI_PORT:-8080}"  # WebUI
      - "${QB_BT_PORT:-6881}:6881/tcp"                     # BT TCP
      - "${QB_BT_PORT:-6881}:6881/udp"                     # BT UDP

    volumes:
      # 全部使用相对路径！在 PT_JP/ 目录下 docker compose up 即可
      - ./config:/config
      - ./data:/downloads

    # ---- 健康检查 ----
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    # ---- 日志限制 (保护SSD) ----
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"