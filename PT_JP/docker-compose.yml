# ===========================================================
#  PT_JP 日本节点 — Docker Compose 编排 (生产级)
#  客户端: Transmission 4.0.6 Official (MT白名单合规)
#  RSS:    FlexGet (自动化 RSS 引擎)
#  策略:   低优先级后台进程，严格资源隔离
#
#  生产级特性:
#    - PUID/PGID: 容器以非 root 用户运行 (由 deploy.sh 自动注入)
#    - Log Rotation: 防止日志撑爆磁盘
#    - Timezone: 宿主机时区映射 + TZ 环境变量
#    - Network: Bridge 模式 (安全隔离 + 多节点兼容)
#    - Healthcheck: 自动检测服务健康状态
#
#  宿主机路径: /home/BT/PT_JP/
#  使用方法:
#    cd /home/BT/PT_JP
#    sudo bash scripts/deploy.sh   # 推荐 (自动处理 .env)
#    docker compose up -d           # 手动 (需先配置 .env)
# ===========================================================

services:
  # ============================================
  #  Transmission — 万级种子保种引擎
  #  资源策略: 低CPU优先级 + 3.5GB内存硬限制
  # ============================================
  transmission:
    image: lscr.io/linuxserver/transmission:${TR_IMAGE_TAG:-4.0.6}
    container_name: transmission_jp
    restart: unless-stopped

    # ===== 资源隔离 (QoS 核心!) =====
    mem_limit: 3584m
    memswap_limit: 4096m
    cpu_shares: 256
    cpus: 3.0
    oom_kill_disable: false

    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Asia/Shanghai}
      - USER=${TR_USER:-admin}
      - PASS=${TR_PASS:-changeme}
      - PEERPORT=${TR_PEER_PORT:-51413}
      - TRANSMISSION_WEB_HOME=/config/transmission-web-control/src

    ports:
      - "${TR_WEBUI_PORT:-9091}:9091"
      - "${TR_PEER_PORT:-51413}:51413/tcp"
      - "${TR_PEER_PORT:-51413}:51413/udp"

    volumes:
      - ./config/transmission:/config
      - ./data:/downloads
      - ./watch:/watch
      - /etc/localtime:/etc/localtime:ro

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9091/transmission/web/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  #  FlexGet — RSS 自动化引擎 + 磁盘守门员
  #  资源策略: 最低优先级 + 256MB 内存
  # ============================================
  flexget:
    image: ghcr.io/flexget/flexget:3.11
    container_name: flexget_jp
    restart: unless-stopped
    user: "${PUID:-1000}:${PGID:-1000}"
    depends_on:
      transmission:
        condition: service_healthy

    mem_limit: 256m
    memswap_limit: 384m
    cpu_shares: 128
    cpus: 1.0

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Asia/Shanghai}
      - FG_WEBUI_PASSWD=${FG_WEBUI_PASS:-flexget}

    ports:
      - "5050:5050"

    volumes:
      - ./config/flexget:/config
      - ./data:/downloads
      - /etc/localtime:/etc/localtime:ro

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

networks:
  default:
    name: pt_network
    driver: bridge