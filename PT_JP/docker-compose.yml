# ===========================================================
#  PT_JP 日本节点 — Docker Compose 编排
#  客户端: Transmission 4.0.6 Official (MT白名单合规)
#  RSS:    FlexGet (替代 qBittorrent 内置 RSS)
#
#  使用方法:
#    cd PT_JP
#    cp .env.example .env && vim .env
#    docker compose up -d
# ===========================================================

services:
  # ============================================
  #  Transmission — 万级种子保种引擎
  # ============================================
  transmission:
    image: lscr.io/linuxserver/transmission:${TR_IMAGE_TAG:-4.0.6}
    container_name: transmission_jp
    restart: unless-stopped

    # 8GB内存充裕，不做过严限制，让TR充分利用OS Cache
    # 仅设软上限防止极端情况
    mem_limit: 6g
    memswap_limit: 7g

    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Asia/Shanghai}
      - USER=${TR_USER:-admin}
      - PASS=${TR_PASS:-changeme}
      - PEERPORT=${TR_PEER_PORT:-51413}
      - TRANSMISSION_WEB_HOME=/config/transmission-web-control/src

    ports:
      - "${TR_WEBUI_PORT:-9091}:9091"
      - "${TR_PEER_PORT:-51413}:51413/tcp"
      - "${TR_PEER_PORT:-51413}:51413/udp"

    volumes:
      - ./config/transmission:/config
      - ./data:/downloads
      - ./watch:/watch

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9091/transmission/web/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================
  #  FlexGet — RSS 自动化引擎 (替代 qB 内置RSS)
  # ============================================
  flexget:
    image: ghcr.io/flexget/flexget:3.11
    container_name: flexget_jp
    restart: unless-stopped
    depends_on:
      transmission:
        condition: service_healthy

    mem_limit: 512m

    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-Asia/Shanghai}
      - FG_WEBUI_PASSWD=${FG_WEBUI_PASS:-flexget}

    ports:
      - "5050:5050"

    volumes:
      - ./config/flexget:/config
      - ./data:/downloads

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"