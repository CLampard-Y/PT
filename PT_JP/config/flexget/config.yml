# ===========================================================
#  FlexGet — 收藏列表自动下载 (Watch Directory 架构)
#
#  RSS 来源: M-Team 收藏列表 (用户手动收藏的小体积种子)
#  策略: 下载 RSS 中所有种子，不遗漏，不重复
#  架构: FlexGet 下载 .torrent → /watch/ → Transmission 自动拾取
# ===========================================================

schedules:
  - tasks: ['mt_free_seed']
    interval:
      minutes: 30
  - tasks: ['clean_transmission']
    interval:
      hours: 1

tasks:
  mt_free_seed:
    rss:
      url: '{? mt_rss_url ?}'
      all_entries: yes

    # 禁用 remember_rejected（防止与 seen 冲突导致无限循环）
    disable:
      - remember_rejected

    # 速率限制（防触发 M-Team 反爬）
    domain_delay:
      m-team.cc: '5 seconds'
      m-team.io: '5 seconds'
      rss.m-team.cc: '5 seconds'
      kp.m-team.cc: '5 seconds'
      api.m-team.cc: '5 seconds'
      halomt.com: '5 seconds'
      manfuz.co: '5 seconds'

    # 数据清洗（防 HTTP Header 换行符）
    manipulate:
      - title:
          replace:
            regexp: '[\r\n]+'
            format: ' '
      - title:
          replace:
            regexp: '^\s+|\s+$'
            format: ''
      - url:
          replace:
            regexp: '[\r\n]+'
            format: ''
      - url:
          replace:
            regexp: '^\s+|\s+$'
            format: ''

    # 去重策略：使用 seen 插件基于 title 去重
    # 原因：
    # 1. M-Team 的 URL 包含动态 token（passkey、uid 等），每次可能不同
    # 2. seen_info_hash 需要先下载种子文件才能提取 info hash，无法避免重复下载
    # 3. 种子的 title 是固定的，可以作为唯一标识
    # 关键：
    # - 不使用 local 参数，让数据持久化到 SQLite 数据库
    # - 使用 fields: - title 而不是 url，避免动态 token 问题
    # - 必须放在 accept_all 之前，在 filter 阶段就过滤掉已下载的种子
    seen:
      fields:
        - title

    # 磁盘保护
    free_space:
      path: /downloads
      space: 25000

    # 接受所有种子（RSS 已是手动收藏，无需过滤）
    accept_all: yes

    # 每次最多处理 20 个
    limit_new: 20

    # 下载 .torrent 到 watch 目录
    download:
      path: /watch/
      fail_html: yes
      temp: /config/.tmp/

  clean_transmission:
    disable: [seen, retry_failed]
    from_transmission:
      host: transmission
      port: 9091
      username: '{? tr_user ?}'
      password: '{? tr_pass ?}'
    if:
      - transmission_status == 'stopped' and transmission_errorString != '':
          transmission:
            host: transmission
            port: 9091
            username: '{? tr_user ?}'
            password: '{? tr_pass ?}'
            action: purge

variables: variables.yml