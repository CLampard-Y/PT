# ===========================================================
#  FlexGet 配置文件 — Watch Directory 架构 (稳健版)
#
#  架构变更 (解决 "unrecognized info" 错误):
#    旧: FlexGet → RPC直传 → Transmission (HTML错误页面也被推送)
#    新: FlexGet → 下载.torrent → fail_html拦截 → 保存到/watch/ → Transmission自动拾取
#
#  关键修复:
#    1. fail_html: yes — 拦截 M-Team 返回的 HTML 错误页面
#    2. download 插件 — 先保存文件，Transmission 自动监控拾取
#    3. 即使漏网，Transmission 也只是忽略无效 .torrent，不会报错
# ===========================================================

schedules:
  - tasks: ['mt_free_seed']
    interval:
      minutes: 30
  - tasks: ['clean_transmission']
    interval:
      hours: 1

tasks:
  mt_free_seed:
    # ===== RSS 源 =====
    rss:
      url: '{? mt_rss_url ?}'
      all_entries: no

    # ===== 速率限制 (防触发 M-Team 反爬) =====
    domain_delay:
      m-team.cc: '5 seconds'
      m-team.io: '5 seconds'
      rss.m-team.cc: '5 seconds'
      kp.m-team.cc: '5 seconds'
      api.m-team.cc: '5 seconds'
      halomt.com: '5 seconds'
      manfuz.co: '5 seconds'

    # ===== 数据清洗 (防 HTTP Header 换行符) =====
    manipulate:
      - title:
          replace:
            regexp: '[\r\n]+'
            format: ' '
      - title:
          replace:
            regexp: '^\s+|\s+$'
            format: ''
      - url:
          replace:
            regexp: '[\r\n]+'
            format: ''
      - url:
          replace:
            regexp: '^\s+|\s+$'
            format: ''

    # ===== 种子大小过滤 =====
    content_size:
      min: 0.0001
      max: 12
      strict: no

    # ===== seen: 仅本任务内记录 =====
    seen:
      local: yes
      fields:
        - url

    # ===== 失败重试 =====
    retry_failed:
      retry_time: 30 minutes
      retry_time_multiplier: 1
      max_retries: 10

    # ===== 磁盘保护 =====
    free_space:
      path: /downloads
      space: 25000

    # ===== 接受所有通过过滤的种子 =====
    accept_all: yes

    # ===== 每次最多处理 20 个 =====
    limit_new: 20

    # ===== 核心修复: 下载 .torrent 到 watch 目录 =====
    # 替代原来的 transmission: RPC 直传
    # fail_html: yes — 如果 M-Team 返回 HTML 错误页面，直接拒绝
    # Transmission 自动监控 /watch/ 目录并拾取有效 .torrent 文件
    download:
      path: /watch/
      fail_html: yes
      temp: /config/.tmp/

  # ===== 清理任务: 移除 Transmission 中的错误种子 =====
  clean_transmission:
    disable: [seen, retry_failed]
    from_transmission:
      host: '{? tr_host ?}'
      port: '{? tr_port ?}'
      username: '{? tr_user ?}'
      password: '{? tr_pass ?}'
    if:
      - transmission_status == 'stopped' and transmission_errorString != '':
          transmission:
            host: '{? tr_host ?}'
            port: '{? tr_port ?}'
            username: '{? tr_user ?}'
            password: '{? tr_pass ?}'
            action: purge

variables: variables.yml